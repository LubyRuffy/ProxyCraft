# PRD: 命令行 HTTPS/HTTP2/SSE 代理工具 (代号: "ProxyCraft CLI")

## 1. 引言 (Introduction)

ProxyCraft CLI 是一款轻量级、高性能的命令行代理工具，旨在为开发人员、安全测试人员和网络管理员提供便捷的流量观察、分析和调试能力。它专注于核心代理功能，支持最新的 Web 协议如 HTTPS, HTTP/2, 以及 Server-Sent Events (SSE)，并且完全通过命令行界面进行操作，无需图形用户界面。其设计灵感来源于 Burp Suite 的代理功能，但更侧重于命令行环境下的易用性和可集成性。

## 2. 目标 (Goals)

*   **核心代理功能:** 提供稳定可靠的 HTTP/HTTPS 代理服务。
*   **现代协议支持:** 无缝支持 HTTP/1.1, HTTP/2, 和 HTTPS (TLS/SSL)。
*   **SSE 协议支持:** 能够正确代理并展示 Server-Sent Events 流量。
*   **命令行友好:** 所有功能通过命令行参数和输出进行交互，易于脚本化和集成到自动化流程中。
*   **流量可视性:** 清晰展示请求和响应的头部、正文等关键信息。
*   **HTTPS 解密:** 支持中间人 (MITM) 攻击以解密和检查 HTTPS 流量。
*   **轻量高效:** 资源占用低，启动速度快，对系统性能影响小。

## 3. 目标用户 (Target Audience)

*   **Web 开发人员:** 调试客户端与服务器之间的通信，理解 API 调用，分析 SSE 流。
*   **API 开发人员:** 测试和验证 API 端点的行为和性能。
*   **安全研究员/渗透测试员:** 初步分析应用流量，识别潜在的通信模式 (非主动攻击工具)。
*   **网络管理员/DevOps 工程师:** 诊断网络连接问题，监控特定应用流量。

## 4. 功能需求 (Functional Requirements)

### 4.1 代理核心 (Proxy Core)

*   **FR1.1:** 工具能够作为 HTTP/HTTPS 代理服务器启动，监听在用户指定的 IP 地址和端口上。
    *   **FR1.1.1:** 默认监听 `127.0.0.1:8080`，用户可通过命令行参数修改。
*   **FR1.2:** 支持 HTTP/1.1 协议的代理。
*   **FR1.3:** 能够将客户端请求转发到目标服务器，并将服务器响应返回给客户端。
*   **FR1.4:** 正确处理各种 HTTP 方法 (GET, POST, PUT, DELETE, HEAD, OPTIONS, PATCH 等)。
*   **FR1.5:** 正确处理常见的 HTTP 状态码。
*   **FR1.6:** 支持 Keep-Alive 连接。

### 4.2 HTTPS 支持 (MITM)

*   **FR2.1:** 能够对 HTTPS 流量进行中间人解密。
*   **FR2.2:** 首次运行时自动生成自签名根 CA 证书。
    *   **FR2.2.1:** 提供命令行选项导出根 CA 证书 (如 `proxycraft-ca.pem`)，方便用户导入到浏览器或操作系统信任存储中。
    *   **FR2.2.2:** 如果 CA 证书已存在，则复用。
*   **FR2.3:** 为客户端请求的每个域名动态生成并使用由自签名根 CA 签发的服务器证书。
*   **FR2.4:** 支持 TLS 1.2 和 TLS 1.3。
*   **FR2.5:** 用户可以通过命令行参数指定自定义的根 CA 证书和私钥。

### 4.3 HTTP/2 支持

*   **FR3.1:** 能够代理 HTTP/2 流量。
*   **FR3.2:** 支持通过 ALPN (Application-Layer Protocol Negotiation) 进行 HTTP/2 协议协商。
*   **FR3.3:** 当客户端和服务器均支持 HTTP/2 时，优先使用 HTTP/2 进行通信。
*   **FR3.4:** 即使客户端仅支持 HTTP/1.1，而服务器支持 HTTP/2（反之亦然），代理也应能正确处理和转换（如果可行且必要，或至少能透明代理）。
*   **FR3.5:** 能够展示 HTTP/2 的帧信息（如 HEADERS, DATA 帧）的概要（详细帧分析可选）。

### 4.4 Server-Sent Events (SSE) 支持

*   **FR4.1:** 能够正确代理使用 SSE 协议的连接 (`Content-Type: text/event-stream`)。
*   **FR4.2:** 保持 SSE 连接的持久性，不因代理的内部机制而意外中断。
*   **FR4.3:** 实时或近实时地在命令行输出中展示接收到的 SSE 事件数据。
    *   **FR4.3.1:** 清晰区分不同的 SSE 事件 (event, data, id, retry 字段)。

### 4.5 流量日志与展示 (Logging & Display)

*   **FR5.1:** 在命令行实时输出捕获到的 HTTP/HTTPS/HTTP2 请求和响应的概要信息。
    *   **FR5.1.1:** 概要信息至少包括：请求方法、URL、协议版本、响应状态码、响应内容类型、响应体大小。
*   **FR5.2:** 提供详细模式，展示完整的请求/响应头部和正文。
    *   **FR5.2.1:** 正文展示时，对常见的 Content-Type (如 JSON, XML, HTML, text) 进行美化输出。
    *   **FR5.2.2:** 对于二进制内容，显示 "[Binary data]" 或十六进制摘要。
*   **FR5.3:** 为每个请求/响应分配一个唯一的序号，方便跟踪。
*   **FR5.4:** 支持将所有捕获的流量（包括头部和正文）保存到指定文件中。
    *   **FR5.4.1:** 支持以 HAR (HTTP Archive) 格式保存（推荐）。
    *   **FR5.4.2:** 支持以自定义的纯文本格式保存。
*   **FR5.5:** 提供过滤功能，允许用户根据域名、URL 路径、请求方法、响应状态码等条件过滤显示的流量。
    *   **FR5.5.1:** 支持简单的字符串匹配和正则表达式匹配。
*   **FR5.6:** 清晰标记通过 HTTPS 解密的流量。
*   **FR5.7:** 对于 SSE 流量，每个事件都应有清晰的时间戳和来源信息。

### 4.6 命令行界面 (CLI)

*   **FR6.1:** 提供清晰的帮助信息 (`-h`, `--help`)，列出所有可用参数及其说明。
*   **FR6.2:** 允许用户通过参数配置监听地址 (`-l HOST` 或 `--listen-host HOST`) 和端口 (`-p PORT` 或 `--listen-port PORT`)。
*   **FR6.3:** 允许用户通过参数启用/禁用详细输出模式 (`-v` 或 `--verbose`)。
*   **FR6.4:** 允许用户通过参数指定日志输出文件 (`-o FILE` 或 `--output-file FILE`) 及格式。
*   **FR6.5:** 允许用户通过参数指定过滤规则 (`--filter "expression"`).
*   **FR6.6:** 提供参数用于管理 CA 证书 (如 `--export-ca FILEPATH`, `--use-ca CERT_PATH --use-key KEY_PATH`)。
*   **FR6.7:** 工具应能通过 `Ctrl+C` 优雅地关闭，并完成必要的清理工作 (如关闭打开的文件)。

## 5. 非功能需求 (Non-Functional Requirements)

*   **NFR1. Performance:**
    *   **NFR1.1:** 代理引入的延迟应尽可能小，对用户体验影响降到最低。
    *   **NFR1.2:** 能够处理中等数量的并发连接（例如，至少 50-100 个并发连接）而不会显著降低性能。
*   **NFR2. Stability & Reliability:**
    *   **NFR2.1:** 工具应能长时间稳定运行，不易崩溃。
    *   **NFR2.2:** 能够优雅处理网络错误、无效请求/响应等异常情况，并给出提示。
*   **NFR3. Security (of the tool itself):**
    *   **NFR3.1:** 生成的 CA 私钥应有合适的权限保护（如果存储在文件系统）。
    *   **NFR3.2:** 避免引入常见的安全漏洞（如命令注入、路径遍历等）。
*   **NFR4. Usability (CLI):**
    *   **NFR4.1:** 命令行参数设计直观易懂。
    *   **NFR4.2:** 输出信息清晰、格式良好，易于阅读和解析。
*   **NFR5. Portability:**
    *   **NFR5.1:** 优先考虑跨平台支持 (Linux, macOS, Windows)。如果选择的语言/库有限制，需明确指出。
*   **NFR6. Maintainability:**
    *   代码结构清晰，易于维护和扩展。

## 6. 技术栈与架构建议 (Technical Considerations - Optional)

*   **语言选择:**
    *   **Go:** 优秀的网络编程能力、并发处理、编译成单个二进制文件、跨平台。
*   **核心库:**
    *   需要 HTTP/1.1, HTTP/2, TLS, TCP Sockets 的库。
    *   证书生成和管理的库 (如 OpenSSL bindings, Go crypto/tls)。
*   **架构:**
    *   事件驱动/异步 I/O 模型以实现高并发。
    *   模块化设计：代理核心、协议处理器 (HTTP/1, HTTP/2, SSE)、MITM 模块、日志模块、CLI 解析模块。

## 7. 里程碑/发布计划 (Milestones - Simplified)

*   **MVP (Minimum Viable Product):**
    *   HTTP/1.1 和 HTTPS (MITM) 代理功能。
    *   基本的命令行启动和流量概要输出。
    *   CA 证书生成和导出。
*   **V1.0:**
    *   完整支持 HTTP/2 代理。
    *   完整支持 SSE 代理和展示。
    *   详细流量日志输出 (头部和正文)。
    *   流量保存到文件 (HAR 格式)。
    *   基本的流量过滤功能。
    *   完善的 CLI 参数和帮助信息。
*   **V1.x (Future):**
    *   更高级的过滤选项。
    *   请求/响应修改能力 (通过脚本或规则)。
    *   交互式命令行界面 (可选)。

## 8. 未来展望 (Future Enhancements - Out of Scope for V1.0)

*   **请求/响应修改:** 允许用户通过规则或脚本修改请求/响应内容。
*   **请求重放:** 能够重放捕获到的请求。
*   **WebSocket 支持:** 代理和展示 WebSocket 流量。
*   **插件系统:** 允许用户通过插件扩展功能。
*   **配置文件支持:** 除了命令行参数，还支持通过配置文件进行设置。
*   **交互式控制台:** 提供类似 `mitmproxy` 的交互式控制台界面，用于更细致地查看和操作流量。

## 9. 成功指标 (Success Metrics)

*   用户能够成功使用工具调试 HTTPS, HTTP/2 和 SSE 应用。
*   工具稳定运行，崩溃率低。
*   社区反馈积极，有用户贡献 issue 或 feature request。
*   在开发者社区（如 GitHub, 技术论坛）获得一定的关注和使用量。
